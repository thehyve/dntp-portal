<!--
Copyright (C) 2016  Stichting PALGA
This file is distributed under the GNU Affero General Public License
(see accompanying file LICENSE).
-->
<h3>{{ 'Samples' | translate}}</h3>
<hr>

<form class="form-horizontal no-print" role="form" name="pathologyForm" novalidate
    ng-if="isLabUser()">
    <!-- PA number -->
    <div class="form-group" ng-if="isLabUser() && labRequest.status == 'Approved'">
        <div class="col-sm-8">
            <input type="text" class="form-control" id="paNumber" name="paNumber" placeholder="{{ 'PA number' | translate }}"
                   ng-model="editPathology.paNumber" ng-maxlength="100"  data-placement="bottom" data-animation="am-flip-x" required
                   ng-disabled="(labRequest.assignee != globals.currentUser.userid)">
        </div>
        <button class="btn btn-primary" title="{{'Add'|translate}}"
            ng-click="addPathology(labRequest, editPathology)"
            ng-disabled="pathologyForm.paNumber.$invalid || (labRequest.assignee != globals.currentUser.userid)">
            {{'Add PA number'|translate}}
        </button>
    </div>
</form>


<table st-table="paNumbersDisplayedCollection" st-safe-src="labRequest.pathologyList" class="table table-striped">
  <thead>
  <tr>
    <th class="print-pa-id-col">{{'Sequence number' | translate}} ({{sequenceNumberColumnName}})</th>
    <th class="print-pa-no-col" st-sort="paNumber" width="10%">{{'PA number' | translate}}</th>
    <th class="print-pa-samples-col">{{'Samples' | translate}}</th>
    <th class="" width="10%">{{'Total Samples' | translate}}</th>
    <th class="no-print" class="" 
        ng-if="isLabUser() && labRequest.assignee == globals.currentUser.userid
            && (labRequest.status == 'Approved' || labRequest.status=='Received' || labRequest.status=='Sending')">
        {{'Actions' | translate}}
    </th>
  </tr>
  <tr class="no-print">
    <th colspan="6"><input id="request-search" st-search="" class="form-control" placeholder="Search ..." type="text"/></th>
  </tr>
  </thead>
  <tbody>
  <tr ng-repeat="pathology in paNumbersDisplayedCollection">
    <td class="print-pa-id-col">
      {{getSequenceNumberForPaNumber(labRequest, pathology.paNumber)}}
    </td>
    <td class="print-pa-no-col">
      {{pathology.paNumber}}
    </td>
    <td class="print-pa-samples-col">
      <tags-input 
        on-tag-added="updatePathology(labRequest, pathology)" 
        on-tag-removed="updatePathology(labRequest, pathology)"
        replace-spaces-with-dashes="false"
        ng-model="pathology.samples" 
        placeholder="Enter sample codes"
        add-on-enter="true"
        add-on-blur="true"
        add-on-paste="true"
        min-length="1"
        ng-if="(labRequest.assignee == globals.currentUser.userid) && labRequest.request.materialsRequest"></tags-input>
        <span ng-if="labRequest.assignee != globals.currentUser.userid">
            <span ng-repeat="sample in pathology.samples">
                <label class="label label-primary">{{sample}}</label>
            </span>
        </span>
    </td>
    <td>{{pathology.samples.length}}</td>
    <td class="no-print" ng-if="isLabUser() && labRequest.assignee == globals.currentUser.userid 
        && (labRequest.status == 'Approved' || labRequest.status == 'Received' || labRequest.status == 'Sending')">
    <span class="pull-right">
        <span class="btn-group">
            <a  ng-if="labRequest.status == 'Approved'"
                class="btn btn-default" role="button" title="{{'Delete'|translate}}"
                ng-click="deletePathology(labRequest, pathology)">
            <span><i class="glyphicon glyphicon-trash"></i></span>
            </a>
            <a  ng-if="labRequest.status=='Received' || labRequest.status=='Sending'"
                href="mailto:{{labRequest.requesterLab.contactData.email ? labRequest.requesterLab.contactData.email
                                : labRequest.requesterEmail}}?subject=Regarding request {{labRequest.labRequestCode}}, recall sample {{pathology.paNumber}}&amp;body=Please return sample {{pathology.paNumber}} a.s.a.p."
                class="btn btn-default" role="button" title="{{'Recall sample' | translate}}">
                <span><i class="glyphicon glyphicon-envelope"></i></span>
                {{'Compose recall mail' | translate}}
            </a>
        </span>
        </span>
    </td>
  </tr>
  </tbody>
</table>
